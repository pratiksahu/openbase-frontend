# FIX_007: Test File Errors

**Priority**: MEDIUM
**Estimated Time**: 1-2 hours
**Files Affected**: 33 errors across 6 files

## Overview

Various TypeScript errors in Playwright test files and component test files, including missing variables, incorrect API usage, and type mismatches.

## Errors to Fix

### 1. Playwright Test Missing 'page' Variable (10 errors)
**Files**:
- `tests/smart-goals/goal-creation.spec.ts:281, 287, 298, 304, 306`
- `tests/smart-goals/goal-management.spec.ts:333, 334, 340, 348, 357, 360, 368, 374, 380, 381, 387`
- `tests/smart-goals/metrics-tracking.spec.ts:83`

```typescript
// ERROR: Cannot find name 'page'
const templateSection = page.locator('[data-testid="templates"]');
const gridViewButton = page.getByRole('button', { name: /grid/i });
```

### 2. Incorrect toHaveCount() Usage (3 errors)
**Files**:
- `tests/goal-pages.spec.ts:43`
- `tests/smart-goals/goal-management.spec.ts:29`
- `tests/smart-goals/task-workflow.spec.ts:167`

```typescript
// ERROR: Argument of type '{ min: number; }' is not assignable to parameter of type 'number'
await expect(goalCards).toHaveCount({ min: 1 });
```

### 3. Missing .or() Method on Expect (2 errors)
**Files**:
- `tests/goal-pages.spec.ts:262, 263`

```typescript
// ERROR: Property 'or' does not exist on type 'MakeMatchers<void, Locator, {}>'
await expect(page.getByRole('button', { name: /zoom in/i })).or(page.locator('[data-testid="zoom-in"]')).toBeVisible();
```

### 4. Promise Chaining Errors (3 errors)
**File**: `tests/task-editor.spec.ts:207, 222, 259`

```typescript
// ERROR: Property 'first' does not exist on type 'Promise<void>'
await page.click('[data-testid="edit-subtask"]').first();
```

### 5. Component Test Issues (9 errors)
**Files**:
- `src/components/TaskEditor/__tests__/SubtaskList.test.tsx:74, 94, 417, 470-472`
- `src/components/TaskEditor/__tests__/TaskEditor.test.tsx:592`

```typescript
// ERROR: Mock type mismatch, DragEndEvent structure issues, etc.
```

### 6. TaskEditor Story Missing Args (1 error)
**File**: `src/components/TaskEditor/TaskEditor.stories.tsx:594`

```typescript
// ERROR: Property 'args' is missing but required
export const LoadingState: Story = {
  render: () => <JSX.Element>,
  // Missing required args property
};
```

## Solution Strategy

### 1. Fix Missing 'page' Variables in Test Functions

Add proper test function signatures:

```typescript
// Before - missing page parameter
test('should load goal templates', async () => {
  const templateSection = page.locator('[data-testid="templates"]'); // ❌
});

// After - add page parameter
test('should load goal templates', async ({ page }) => {
  const templateSection = page.locator('[data-testid="templates"]'); // ✅
});
```

### 2. Fix toHaveCount() Usage

Update to use correct count assertion:

```typescript
// Before
await expect(goalCards).toHaveCount({ min: 1 }); // ❌

// After - use toHaveCount for exact count
await expect(goalCards).toHaveCount(3); // ✅ for exact count

// Or use custom matcher for minimum count
await expect(goalCards.count()).toBeGreaterThanOrEqual(1); // ✅ for minimum
```

### 3. Fix .or() Method Usage

Replace with proper Playwright locator chaining:

```typescript
// Before
await expect(page.getByRole('button', { name: /zoom in/i }))
  .or(page.locator('[data-testid="zoom-in"]')) // ❌ .or() doesn't exist on expect
  .toBeVisible();

// After - use locator.or() instead
await expect(
  page.getByRole('button', { name: /zoom in/i })
    .or(page.locator('[data-testid="zoom-in"]')) // ✅ .or() on locator
).toBeVisible();
```

### 4. Fix Promise Chaining

Separate click action from element selection:

```typescript
// Before
await page.click('[data-testid="edit-subtask"]').first(); // ❌ .first() on Promise

// After
await page.locator('[data-testid="edit-subtask"]').first().click(); // ✅
```

### 5. Fix Component Test Issues

Update test expectations and mock structures:

```typescript
// Fix toHaveClass with multiple classes
expect(element).toHaveClass('class1 class2'); // ✅ Single string

// Fix DragEndEvent mock
const mockDragEvent: DragEndEvent = {
  active: {
    id: 'item-1',
    data: { current: {} },
    rect: { /* proper rect object */ }
  },
  over: {
    id: 'item-2',
    data: { current: {} },
    rect: { /* proper rect object */ },
    disabled: false
  },
  // ... other required properties
};
```

## Implementation Steps

### Phase 1: Fix Playwright Test Function Signatures
1. **Add `{ page }` parameter** to all test functions missing it
2. **Verify all page usages** have proper scope
3. **Run tests** to ensure page context works

### Phase 2: Fix Playwright API Usage
1. **Replace toHaveCount({ min: n })** with proper assertions
2. **Fix .or() method chaining** on locators vs expectations
3. **Fix promise chaining** with .first() and other methods

### Phase 3: Fix Component Tests
1. **Update mock objects** to match expected interfaces
2. **Fix test assertion syntax** for multiple classes
3. **Add missing Story args** in Storybook files

## Files to Modify

### Playwright Test Files
- [ ] `tests/smart-goals/goal-creation.spec.ts` - Add page parameters, fix API usage
- [ ] `tests/smart-goals/goal-management.spec.ts` - Add page parameters, fix counts
- [ ] `tests/smart-goals/metrics-tracking.spec.ts` - Add page parameter
- [ ] `tests/smart-goals/task-workflow.spec.ts` - Fix toHaveCount usage
- [ ] `tests/goal-pages.spec.ts` - Fix .or() usage and counts
- [ ] `tests/task-editor.spec.ts` - Fix promise chaining

### Component Test Files
- [ ] `src/components/TaskEditor/__tests__/SubtaskList.test.tsx` - Fix mocks and assertions
- [ ] `src/components/TaskEditor/__tests__/TaskEditor.test.tsx` - Fix mock types
- [ ] `src/components/TaskEditor/TaskEditor.stories.tsx` - Add missing args

## Specific Fixes

### Test Function Signatures
```typescript
// Pattern to find and fix
test('test description', async () => {
  page.locator(...) // ❌ page is undefined
});

// Fix with
test('test description', async ({ page }) => {
  page.locator(...) // ✅ page is injected
});
```

### Count Assertions
```typescript
// Replace all instances
.toHaveCount({ min: 1 }) → .toHaveCount(expectedNumber)
// or
.count()).toBeGreaterThanOrEqual(1) // for minimum counts
```

### Locator Chaining
```typescript
// Replace
expect(locator).or(otherLocator).assertion()
// With
expect(locator.or(otherLocator)).assertion()
```

## Testing Checklist

- [ ] All Playwright tests compile without TypeScript errors
- [ ] All test files run successfully
- [ ] Component tests pass with proper mocks
- [ ] Storybook loads all stories without errors
- [ ] No undefined variables in test context

## Impact Assessment

- **Medium Priority**: Tests are important but don't block functionality
- **Development Quality**: Clean tests improve debugging and confidence
- **CI/CD**: Fixed tests will pass in automated testing pipelines

## Dependencies

- No blocking dependencies
- Can be worked on in parallel with other fixes
- Should be completed before major releases