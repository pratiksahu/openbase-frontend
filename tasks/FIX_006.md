# FIX_006: State Management Issues

**Priority**: HIGH
**Estimated Time**: 1-2 hours
**Files Affected**: 23 errors across 3 files

## Overview

Critical issues in Zustand store implementations including type conflicts, undefined variables, and missing exports.

## Errors to Fix

### 1. SelectionStore showSelectionBar Type Conflict (15 errors)
**File**: `src/lib/state/goals/selectionStore.ts`

**Issue**: `showSelectionBar` is defined as `boolean` but implemented as both boolean and function.

```typescript
// ERROR: Type conflicts throughout the file
state.showSelectionBar = true;   // ❌ boolean assignment
state.showSelectionBar = false;  // ❌ boolean assignment
showSelectionBar: () => {        // ❌ function implementation
```

**Line Numbers**: 237, 254, 289, 299, 309, 319, 334, 377, 385, 393, 468, 680, 682, 688, 694

### 2. GoalStore Undefined Variables (5 errors)
**File**: `src/lib/state/goals/goalStore.ts`

**Issue**: References to undefined variables in optimistic update rollback logic.

```typescript
// ERROR: Cannot find name 'originalGoal' and 'originalGoals'
if (originalGoal) {              // ❌ Line 483
  state.goals[index] = originalGoal; // ❌ Line 487
}
state.goals = originalGoals;     // ❌ Lines 530, 621, 644
```

### 3. Missing Store Exports (3 errors)
**File**: `src/lib/state/index.ts`

**Issue**: Importing undefined store hooks.

```typescript
// ERROR: Cannot find name
goals: useGoalStore,        // ❌ Line 193
selection: useSelectionStore, // ❌ Line 194
wizard: useWizardStore,     // ❌ Line 195
```

## Solution Strategy

### 1. Fix SelectionStore Type Conflict

**Option A: Boolean Only (Recommended)**
```typescript
interface SelectionStore {
  showSelectionBar: boolean;
  // ... other properties

  // Actions (separate from state)
  setShowSelectionBar: (show: boolean) => void;
  toggleSelectionBar: () => void;
}
```

**Option B: Function Only**
```typescript
interface SelectionStore {
  showSelectionBar: () => boolean;
  // ... other properties
}
```

### 2. Fix GoalStore Optimistic Updates

Add proper variable declarations and error handling:

```typescript
// Create backup variables before mutations
const originalGoal = state.goals.find(g => g.id === goalId);
const originalGoals = [...state.goals];

try {
  // Perform optimistic update
  // ...
} catch (error) {
  // Rollback using saved originals
  if (originalGoal) {
    const index = state.goals.findIndex(g => g.id === goalId);
    if (index >= 0) {
      state.goals[index] = originalGoal;
    }
  }
  // Or rollback entire array
  state.goals = originalGoals;
}
```

### 3. Fix Missing Store Exports

Ensure all stores are properly exported:

```typescript
// In respective store files
export const useGoalStore = create<GoalStore>()(/* store definition */);
export const useSelectionStore = create<SelectionStore>()(/* store definition */);
export const useWizardStore = create<WizardStore>()(/* store definition */);
```

## Implementation Steps

### Phase 1: Fix SelectionStore (High Priority)
1. **Decide on showSelectionBar type** (boolean vs function)
2. **Update interface definition** to match chosen approach
3. **Fix all assignments** throughout the file
4. **Create proper action methods** for state updates
5. **Test selection functionality**

### Phase 2: Fix GoalStore Optimistic Updates
1. **Identify all optimistic update patterns** in the store
2. **Add proper variable scoping** for rollback data
3. **Implement consistent error handling** pattern
4. **Test goal CRUD operations** with error scenarios

### Phase 3: Fix Store Exports
1. **Verify store hook exports** in each store file
2. **Update index.ts imports** to match actual exports
3. **Test store usage** throughout application

## Files to Modify

### SelectionStore Fixes
- [ ] `src/lib/state/goals/selectionStore.ts` - Fix type conflicts and implementation

### GoalStore Fixes
- [ ] `src/lib/state/goals/goalStore.ts` - Fix undefined variables and optimistic updates

### Export Fixes
- [ ] `src/lib/state/goals/goalStore.ts` - Ensure useGoalStore is exported
- [ ] `src/lib/state/goals/selectionStore.ts` - Ensure useSelectionStore is exported
- [ ] `src/lib/state/goals/wizardStore.ts` - Ensure useWizardStore is exported
- [ ] `src/lib/state/index.ts` - Fix import statements

## Detailed Fix Plans

### SelectionStore showSelectionBar Fix

**Current problematic code:**
```typescript
interface SelectionStore {
  showSelectionBar: boolean; // ❌ Type says boolean
}

// But implemented as:
showSelectionBar: () => {    // ❌ Implementation is function
  state.showSelectionBar = true; // ❌ Treating as boolean
}
```

**Recommended fix:**
```typescript
interface SelectionStore {
  showSelectionBar: boolean;
  setShowSelectionBar: (show: boolean) => void;
  toggleSelectionBar: () => void;
}

// Implementation:
const useSelectionStore = create<SelectionStore>()((set) => ({
  showSelectionBar: false,

  setShowSelectionBar: (show) => set((state) => {
    state.showSelectionBar = show;
  }),

  toggleSelectionBar: () => set((state) => {
    state.showSelectionBar = !state.showSelectionBar;
  }),
}));
```

### GoalStore Optimistic Update Pattern

**Create consistent pattern for all operations:**
```typescript
const optimisticUpdate = async <T>(
  operation: () => Promise<T>,
  optimisticFn: (state: Draft<GoalStore>) => void,
  rollbackFn: (state: Draft<GoalStore>) => void
): Promise<T> => {
  try {
    optimisticFn(get());
    const result = await operation();
    return result;
  } catch (error) {
    rollbackFn(get());
    throw error;
  }
};
```

## Testing Checklist

- [ ] SelectionStore compiles without type errors
- [ ] Selection bar functionality works correctly
- [ ] GoalStore operations handle errors gracefully
- [ ] Optimistic updates rollback properly on failure
- [ ] All store hooks are accessible from index.ts
- [ ] No undefined variable errors in any store

## Critical Impact

This fix is **HIGH PRIORITY** because:
- Store type errors can cause runtime failures
- Optimistic update bugs can lead to data inconsistency
- Missing exports break store usage throughout the app

## Dependencies

- Should be fixed before major feature development
- May affect other components using these stores