# FIX_008: Validation & Utils Issues

**Priority**: LOW
**Estimated Time**: 30-45 minutes
**Files Affected**: 5 errors across 3 files

## Overview

Small collection of utility and validation-related TypeScript errors including Zod validation configuration and error handling type issues.

## Errors to Fix

### 1. Zod errorMap Property Issues (2 errors)
**File**: `src/components/TaskEditor/TaskEditor.utils.ts:49, 53`

```typescript
// ERROR: Object literal may only specify known properties, and 'errorMap' does not exist
z.nativeEnum(TaskStatus, {
  errorMap: () => ({ message: 'Please select a valid status' })  // ❌
}),
z.nativeEnum(GoalPriority, {
  errorMap: () => ({ message: 'Please select a valid priority' }) // ❌
})
```

### 2. Error Handling Type Issues (2 errors)
**File**: `src/lib/utils/errorHandler.ts:75, 76`

```typescript
// ERROR: 'AppError' only refers to a type, but is being used as a value
if (error instanceof AppError) { // ❌ Line 75
  return error; // ❌ Line 76 - Type 'unknown' is not assignable to type 'AppError'
}
```

### 3. React Performance Utility Type Issue (1 error)
**File**: `src/lib/utils/performance.ts:524`

```typescript
// ERROR: Argument type issue with React.createElement
return React.createElement(Component as any, props); // ❌
```

## Solution Strategy

### 1. Fix Zod errorMap Usage

Zod's `nativeEnum` doesn't support `errorMap` directly. Use proper Zod error handling:

```typescript
// Before - incorrect usage
z.nativeEnum(TaskStatus, {
  errorMap: () => ({ message: 'Please select a valid status' }) // ❌
}),

// After - use refine or proper error handling
z.nativeEnum(TaskStatus, {
  required_error: 'Please select a valid status',
  invalid_type_error: 'Please select a valid status'
})

// OR use .refine() for custom validation
z.nativeEnum(TaskStatus).refine(
  (value) => Object.values(TaskStatus).includes(value),
  { message: 'Please select a valid status' }
)
```

### 2. Fix AppError Type vs Value Issue

Create proper class/type distinction:

```typescript
// Option A: Make AppError a class (if it should be instantiable)
export class AppError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'AppError';
  }
}

// Then use instanceof works
if (error instanceof AppError) { // ✅
  return error; // ✅
}

// Option B: Use type guards instead of instanceof
function isAppError(error: unknown): error is AppError {
  return error !== null &&
         typeof error === 'object' &&
         'message' in error &&
         'code' in error;
}

// Usage
if (isAppError(error)) {
  return error;
}
```

### 3. Fix React createElement Type Issue

Add proper type constraints to the generic function:

```typescript
// Before
export function profileComponent<P>(
  Component: React.ComponentType<P>
): React.ComponentType<P> {
  return React.createElement(Component as any, props); // ❌
}

// After - add proper constraint
export function profileComponent<P extends React.Attributes | null | undefined>(
  Component: React.ComponentType<P>
): React.ComponentType<P> {
  return React.createElement(Component, props); // ✅
}

// Or use React.forwardRef pattern if needed
export function profileComponent<P>(
  Component: React.ComponentType<P>
) {
  return React.forwardRef<any, P>((props, ref) => {
    return React.createElement(Component, { ...props, ref });
  });
}
```

## Implementation Steps

### Phase 1: Fix Zod Validation (5 minutes)
1. **Replace errorMap with proper Zod options** in TaskEditor.utils.ts
2. **Test form validation** to ensure errors still display correctly

### Phase 2: Fix Error Handling (15 minutes)
1. **Determine if AppError should be class or type** by checking usage
2. **Implement proper solution** (class or type guard)
3. **Update error handling logic** throughout the application
4. **Test error scenarios** to ensure proper handling

### Phase 3: Fix Performance Utility (15 minutes)
1. **Add proper type constraints** to profileComponent function
2. **Test component profiling** functionality
3. **Ensure no runtime errors** in profiled components

## Files to Modify

- [ ] `src/components/TaskEditor/TaskEditor.utils.ts` - Fix Zod errorMap usage
- [ ] `src/lib/utils/errorHandler.ts` - Fix AppError type/class issue
- [ ] `src/lib/utils/performance.ts` - Fix React.createElement typing
- [ ] `src/types/Error.types.ts` (if exists) - Update AppError definition

## Specific Fixes

### Zod errorMap Replacement
```typescript
// Replace in TaskEditor.utils.ts
const taskFormSchema = z.object({
  status: z.nativeEnum(TaskStatus, {
    required_error: 'Please select a valid status',
    invalid_type_error: 'Please select a valid status'
  }),
  priority: z.nativeEnum(GoalPriority, {
    required_error: 'Please select a valid priority',
    invalid_type_error: 'Please select a valid priority'
  }),
  // ... rest of schema
});
```

### Error Handler Fix
```typescript
// In errorHandler.ts - choose one approach

// Approach A: Class-based (if AppError should be instantiable)
export class AppError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'AppError';
  }
}

export function handleError(error: unknown): AppError {
  if (error instanceof AppError) {
    return error;
  }
  // Convert other errors to AppError
  return new AppError(error instanceof Error ? error.message : 'Unknown error');
}

// Approach B: Type guard (if AppError is just a type)
interface AppError {
  message: string;
  code?: string;
}

function isAppError(error: unknown): error is AppError {
  return error !== null &&
         typeof error === 'object' &&
         'message' in error;
}

export function handleError(error: unknown): AppError {
  if (isAppError(error)) {
    return error;
  }
  return {
    message: error instanceof Error ? error.message : 'Unknown error'
  };
}
```

### Performance Utility Fix
```typescript
// In performance.ts
export function profileComponent<P extends React.Attributes>(
  Component: React.ComponentType<P>
): React.ComponentType<P> {
  return (props: P) => {
    // Profiling logic here
    return React.createElement(Component, props);
  };
}
```

## Testing Checklist

- [ ] Form validation still shows proper error messages
- [ ] Error handling works correctly in edge cases
- [ ] Component profiling doesn't break component rendering
- [ ] All TypeScript errors are resolved
- [ ] No runtime errors introduced

## Quick Win Assessment

This is a **LOW PRIORITY** set of fixes because:
- Small number of errors (5 total)
- Mostly cosmetic/type safety issues
- Don't block core functionality
- Can be fixed quickly once started

## Dependencies

- No blocking dependencies
- Can be worked on independently
- Should be completed for clean TypeScript build